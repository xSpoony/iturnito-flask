{# --- ¡CORRECCIÓN CLAVE! --- #}
{# Ahora esta plantilla HEREDA de app.html #}
{% extends 'layouts/app.html' %}


{# --- BLOQUE DE TÍTULO --- #}
{# Define el título que 'app.html' usará #}
{% block title %}{% block header_title %}Panel Paciente{% endblock %} - Sistema Médico{% endblock %}


{# --- BLOQUE DE CONTENIDO --- #}
{# Todo el contenido visible de la página va aquí #}
{% block content %}
<body class="bg-gray-50 min-h-screen">

    <!-- Sistema de "Flash Messages" de Flask -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div x-data="{
                show: true,
                type: '{{ messages[0][0] }}',
                message: '{{ messages[0][1] }}'
             }"
             x-show="show"
             x-init="setTimeout(() => show = false, 5000)"
             x-transition
             class="fixed top-4 left-1/2 transform -translate-x-1/2 z-50 max-w-sm w-full mx-4">

            <div :class="{
                'bg-green-600 border-green-500': type === 'success',
                'bg-red-600 border-red-500': type === 'danger',
                'bg-amber-600 border-amber-500': type === 'warning',
                'bg-gray-900 border-gray-800': type === 'info'
            }" class="text-white px-4 py-3 rounded-lg shadow-lg border">

                <div class="flex items-center space-x-3">
                    <!-- Icono (simplificado) -->
                    <div class="flex-shrink-0">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                    </div>
                    <p class="font-medium text-sm flex-1" x-text="message"></p>
                    <button @click="show = false" class="ml-2 text-green-100 hover:text-white flex-shrink-0">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        {% endif %}
    {% endwith %}

    <!-- Header Principal -->
    <div class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-40">
        <div class="max-w-md mx-auto px-4 py-3">
            <div class="flex items-center justify-between">

                {% if request.endpoint != 'paciente.dashboard' %}
                <a href="{{ url_for('paciente.dashboard') }}"
                   class="w-9 h-9 rounded-lg bg-gray-100 flex items-center justify-center text-gray-600 hover:bg-gray-200 transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </a>
                {% else %}
                <div class="w-9"></div>
                {% endif %}

                <h1 class="text-lg font-semibold text-gray-800 text-center flex-1">
                    <!--
                      --- ¡LA CORRECCIÓN ESTÁ AQUÍ! ---
                      Este es el ÚNICO bloque 'header'.
                    -->
                    {% block header %}Panel Paciente{% endblock %}
                </h1>

                <!-- Avatar/Perfil -->
                <a href="{{ url_for('paciente.perfil') }}" class="w-9 h-9 rounded-lg bg-gray-900 flex items-center justify-center hover:bg-blue-700 transition-colors">
                    <span class="text-white font-semibold text-sm">
                        {{ current_user.name[0] }}
                    </span>
                </a>
            </div>
        </div>
    </div>

    <!-- Contenido Principal -->
    <div class="max-w-md mx-auto px-4 py-4">
        {% block main_content %}{% endblock %}
    </div>
</body>
{% endblock %}


{# --- BLOQUE DE ESTILOS --- #}
{# Todo el CSS personalizado va aquí #}
{% block styles %}
    <style>
        .safe-area-pb {
            padding-bottom: env(safe-area-inset-bottom);
        }
        body {
            -webkit-overflow-scrolling: touch;
        }
        input, select, textarea {
            font-size: 16px;
        }
        html {
            scroll-behavior: smooth;
        }
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        button:focus,
        a:focus,
        input:focus,
        select:focus,
        textarea:focus {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
        }
        @media (hover: hover) {
            .hover\:bg-blue-700:hover {
                background-color: #1d4ed8;
            }
            .hover\:bg-gray-200:hover {
                background-color: #e5e7eb;
            }
        }
    </style>
{% endblock %}


{# --- BLOQUE DE SCRIPTS --- #}
{# Todo el JavaScript personalizado va aquí #}
{% block scripts %}
    <script>
        // Manejar estados de carga
        document.addEventListener('DOMContentLoaded', function() {
            // Agregar indicador de carga para formularios
            const forms = document.querySelectorAll('form');
            forms.forEach(form => {
                form.addEventListener('submit', function() {
                    const submitBtn = form.querySelector('button[type="submit"]');
                    if (submitBtn && !submitBtn.disabled) {
                        submitBtn.disabled = true;
                        const originalText = submitBtn.innerHTML;
                        submitBtn.innerHTML = `
                            <svg class="animate-spin w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            Procesando...
                        `;

                        // Restaurar después de 10 segundos como fallback
                        setTimeout(() => {
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = originalText;
                        }, 10000);
                    }
                });
            });

            // Mejorar navegación back
            window.addEventListener('popstate', function(e) {
                // Aquí puedes agregar lógica adicional si es necesario
            });
        });

        // Función global para mostrar mensajes
        window.mostrarMensaje = function(mensaje, tipo = 'info') {
            const container = document.createElement('div');
            container.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 z-50 max-w-sm w-full mx-4';

            const colores = {
                success: 'bg-green-600 border-green-500',
                error: 'bg-red-600 border-red-500',
                warning: 'bg-amber-600 border-amber-500',
                info: 'bg-gray-900 border-gray-800'
            };

            container.innerHTML = `
                <div class="${colores[tipo]} text-white px-4 py-3 rounded-lg shadow-lg border">
                    <div class="flex items-center space-x-3">
                        <p class="font-medium text-sm flex-1">${mensaje}</p>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" class="text-white hover:text-gray-200 flex-shrink-0">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(container);

            // Auto-remove después de 5 segundos
            setTimeout(() => {
                if (container.parentNode) {
                    container.remove();
                }
            }, 5000);
        };
    </script>
{% endblock %}

